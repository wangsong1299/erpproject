 {% extends "base_erp.html" %}
 {% load i18n admin_static %}
{% block head %}
<link rel="stylesheet" href="{% static "erp/css/sales.css" %}">
{% endblock %}

			{% block inner_header %}
					
			{% endblock %}	

 {% block main %}
 <div class="main long_main" style="overflow:hidden;">
		<div class="line2">
							销售：送货单	
				</div>

 	<div id="choice_1_box">
 		 <div class="head_row"  style="margin-top:0;text-align:center;font-size:20px">
 			鄞州联城包装彩印有限公司送货单
 		</div>
 		 <div class="head_row" style="margin-top:0">
 			<label for="deliveryID">送货单号</label>
 			<input type="text" id="deliveryID" style="font-size:16px" value="{{deliveryID}}"> 	
 		</div>
 		 <div class="head_row" style="margin-top:0">
 			<label for="delivery_name" style="width:150px">收货单位或姓名</label>
 			<input type="text" id="delivery_name" style="width:250px;font-size:16px" value=''>
 			<label for="delivery_time">填写时间</label>
 			<input type="text" id="delivery_time" style="font-size:16px" onClick="WdatePicker()">
 		</div>


	<table class="delivery_table">
		<tr>
			<th class="col_15">订单号<span class="red">*</span></th>
			<th class="col_25">名称与规格<span class="red">*</span></th>
			<th class="col_10">订单数量<span class="red">*</span></th>
			<th class="col_10">送货数量<span class="red">*</span></th>
			<th class="col_10">单价<span class="red">*</span></th>
			<th class="col_10">金额<span class="red">*</span></th>
			<th class="col_20">备注</th>
		</tr>

		<tr style="font-size:12px">
			<th class="col_15"><input type="text" class="productID_1" id="productID_1"></th>
			<th class="col_25"><input type="text" id="product_name_1"></th>
			<th class="col_10"><input type="number" id="order_amount_1"></th>
			<th class="col_10"><input type="number" id="delivery_amount_1"></th>
			<th class="col_10"><input type="hidden" id="price_1" ><input type="hidden" id="customer_1" ></th>
			<th class="col_10"><input type="hidden" id="fee_1" ></th>
			<th class="col_20"><input type="text" id="notes_1"></th>
		</tr>

		<tr style="font-size:12px">
			<th class="col_15"><input type="text" class="productID_1" id="productID_2"></th>
			<th class="col_25"><input type="text" id="product_name_2"></th>
			<th class="col_10"><input type="number" id="order_amount_2"></th>
			<th class="col_10"><input type="number" id="delivery_amount_2"></th>
			<th class="col_10"><input type="hidden" id="price_2"><input type="hidden" id="customer_2" ></th>
			<th class="col_10"><input type="hidden" id="fee_2"></th>
			<th class="col_20"><input type="text" id="notes_2"></th>
		</tr>	
		<tr style="font-size:12px">
			<th class="col_15"><input type="text" class="productID_1" id="productID_3"></th>
			<th class="col_25"><input type="text" id="product_name_3"></th>
			<th class="col_10"><input type="number" id="order_amount_3"></th>
			<th class="col_10"><input type="number" id="delivery_amount_3"></th>
			<th class="col_10"><input type="hidden" id="price_3"><input type="hidden" id="customer_3" ></th>
			<th class="col_10"><input type="hidden" id="fee_3"></th>
			<th class="col_20"><input type="text" id="notes_3"></th>
		</tr>
		<tr style="font-size:12px">
			<th class="col_15"><input type="text" class="productID_1" id="productID_4"></th>
			<th class="col_25"><input type="text" id="product_name_4"></th>
			<th class="col_10"><input type="number" id="order_amount_4"></th>
			<th class="col_10"><input type="number" id="delivery_amount_4"></th>
			<th class="col_10"><input type="hidden" id="price_4"><input type="hidden" id="customer_4" ></th>
			<th class="col_10"><input type="hidden" id="fee_4"></th>
			<th class="col_20"><input type="text" id="notes_4"></th>
		</tr>
		<tr style="font-size:12px">
			<th class="col_15"><input type="text" class="productID_1" id="productID_5"></th>
			<th class="col_25"><input type="text" id="product_name_5"></th>
			<th class="col_10"><input type="number" id="order_amount_5"></th>
			<th class="col_10"><input type="number" id="delivery_amount_5"></th>
			<th class="col_10"><input type="hidden" id="price_5"><input type="hidden" id="customer_5" ></th>
			<th class="col_10"><input type="hidden" id="fee_5"></th>
			<th class="col_20"><input type="text" id="notes_5"></th>
		</tr>
		</table>
		<table class="delivery_table">
		<tr>
			<th class="col_10">交货地址</th>
			<th class="col_50"><input type="text" id="delivery_address"></th>
			<th class="col_10">金额合计</th>
			<th class="col_30"><input type="number" id="total_fee" style="font-size:16px"></th>
		</tr>
		</table>		
		<div class="head_row" style="margin-top:5px;">
 			<label for="receive_man" style="width:100px">送货单位经办人</label>
 			<input type="text" id="receive_man" style="width:150px;font-size:16px" value=''>
 			<label for="delivery_man">电话</label>
 			<input type="text" id="delivery_man" style="font-size:16px" value=''>
 			<label for="delivery_man">经办人</label>
 			<input type="hidden" id="" style="" value=''>
 		</div>

 		<div class="head_row last_row" style="margin-bottom:40px">
 		   <button type="submit" class="btn btn-primary" id="submit_1">点击生成送货单</button>
 		</div>

 		
 	</div>


  </div>
 
 {% endblock %}

{% block javascript %}

 	<script type="text/javascript">
	$(document).ready(function(){
		$("#sales_box").show();	
		$("#delivery").addClass('subtitle_focus');

	    var date=new Date();
	    var month = (parseInt(date.getMonth())+1)<10?'0'+(parseInt(date.getMonth())+1):parseInt(date.getMonth())+1;
	    var day = date.getDate()<10?'0'+date.getDate():date.getDate();
		var newdate= date.getFullYear()+'-'+month+'-'+day;
		$("#delivery_time").val(newdate);

		var choice = {{ choice|safe }};
		if(choice==1){
			$("#choice_1_box").show();

			$("#submit_1").click(function(){
			var maxnum=0;

				$(".productID_1").each(function(a,b){
					var temp = $.trim($(b).val());
					if(temp.length!=0){
						var num = $(b).attr("id").split("_")[1];
						if(num>maxnum){
							maxnum=num;
						}
					}
				});

				var deliveryID=$("#deliveryID").val();
				var delivery_name=$("#delivery_name").val();
				var delivery_time=$("#delivery_time").val();
				var receive_man=$("#receive_man").val();
				var delivery_man=$("#delivery_man").val();
				var total_fee=$("#total_fee").val();
				var delivery_address=$("#delivery_address").val();
				var choice=1;

				for(var i=1;i<=maxnum;i++){
					console.log(i);
					var productID=$("#productID_"+i).val();
					var product_name=$.trim($("#product_name_"+i).val());
					var order_amount=$.trim($("#order_amount_"+i).val());
					var delivery_amount=$.trim($("#delivery_amount_"+i).val());
					var price=$.trim($("#price_"+i).val());
					var fee=$.trim($("#fee_"+i).val());
					var notes=$.trim($("#notes_"+i).val());
					var customer=$.trim($("#customer_"+i).val());

					if(productID.length==0){
						alert("第"+i+"行的订单号不能为空");
						i=maxnum;
					}else if(order_amount.length==0){
						alert("第"+i+"行的订单数量不能为空");
						i=maxnum;
					}else if(delivery_amount.length==0){
						alert("第"+i+"行的送货数量不能为空");
						i=maxnum;
					}else if(product_name.length==0){
						alert("第"+i+"行的产品名称不能为空");
						i=maxnum;
					}else{
						$.ajax({
		                      type : "POST",
		                      url : "/sales/fill_delivery/",
		                      data:{'deliveryID':deliveryID,'choice':choice,'delivery_name':delivery_name,'delivery_time':delivery_time,'receive_man':receive_man,'delivery_man':delivery_man,'delivery_address':delivery_address,'total_fee':total_fee,'productID':productID,'product_name':product_name,'order_amount':order_amount,'delivery_amount':delivery_amount,'price':price,'fee':fee,'notes':notes,'customer':customer},
		                      dataType : "json",
		                      success : function(data) {  
		                      		if(data==1){
		                      			maxnum--;
		                      			if(maxnum==0){
			                      			alert("录入成功");
			                      			window.location.href='/sales/delivery_list/1';
			                      		}
		                      		}else{
		                      			alert("订单号为"+data.code+"录入失败："+data.message);
		                      			i=maxnum;
		                      		}
		                      }
                		  })
					}

				}
			})

 			$(".productID_1").blur(function(){
 				var productID = $(this).val();
 				if(productID!=''){
 					var num = $(this).attr("id").split("_")[1];
	 				$.ajax({
	                      type : "POST",
	                      url : "/sales/get_details_from_order/",
	                      data:{'productID':productID},
	                      dataType : "json",
	                      success : function(data){  
	                      		if(data==0){
	                      			alert("没有订单号为"+productID+"的订单信息")
	                      		}else{
	                      			$("#product_name_"+num).val(data[0]);
		                      	    $("#order_amount_"+num).val(data[1]);
		                      		$("#delivery_amount_"+num).val(data[1]);
		                      		$("#price_"+num).val(data[2]);
		                      		$("#fee_"+num).val(data[3]);
		                      		$("#notes_"+num).val(data[4]);
		                      		$("#customer_"+num).val(data[5]);
	                      		}
	                      }
	                  })
 				}
 			})
		}
//choice1 end

	})</script>

{% endblock %}